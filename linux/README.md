# OS

DOC:
[Linux 启动过程分析](https://mp.weixin.qq.com/s/puA62ZMmteBPo0uIaHSHqg)

操作系统的启动过程：

加电 --> 固件启动(BIOS/UEFI) --> BootLoader 启动（加载操作系统）--> 操作系统启动

- 固件是在电脑出厂时就烧录在ROM硬件上的程序，这部分内容不能随意改变，区别于硬件和软件，这部分被称为固件。固件会对计算机进行基本的自检和初始化工作，例如检查键盘和显示器，根据设置从哪个磁盘/软盘/U盘启动等等，并从其加载数据到内存并执行。主流的固件有 BIOS 和 UEFI。然后将启动器或者操作系统加载进内存，然后跳转到其继续执行。

- 启动器（引导程序）则是操作系统的的固件之间的一个交接程序，负责将操作系统加载进内存。**之所以有启动器这个过程，主要是为了支持在一台计算机上启动多种操作系统。如果不需要支持多系统启动，则固件可以直接加载操作系统进内存。例如嵌入式设备使用的 U-boot 固件则直接加载操作体统进内存。常见的启动器有 GRUB 和 LILO。

- 操作系统开始执行。内核会在获得控制权之后进行各种设备的初始化。虽然固件程序已经初始化了一些设备，但这些设备的数据并没有传递给内核，内核会根据自己的需要再次进行初始化。如内存管理，进程管理等，这个阶段 Linux 内核无法加载模块，这些设备以及文件系统的驱动程序必须同内核编译进同一文件，以便内核使用，不能使用模块方式。


## 内核执行

1.2　加载操作系统内核程序并为保护模式做准备
从现在开始，就要执行真正的 boot 操作了，即把软盘中的操作系统程序加载至内存。对于Linux 0.11操作系统而言，计算机将分三批逐次加载操作系统的内核代码。第一批由BIOS中断 int 0x19 把第一扇区 bootsect 的内容加载到内存；第二批、第三批在bootsect的指挥下，分别把其后的4个扇区和随后的240个扇区的内容加载至内存。

1.2.1　加载第一部分内核代码——引导程序（bootsect）

按照我们使用计算机的经验，如果在开机的时候马上按Del键，屏幕上会显示一个BIOS画面，可以在里面设置启动设备。现在我们基本上都是将硬盘设置为启动盘。Linux 0.11是1991年设计的操作系统，那时常用的启动设备是软驱以及其中的软盘。站在体系结构的角度看，从软盘启动和从硬盘启动的基本原理和机制是类似的。

经过执行一系列 BIOS 代码之后，计算机完成了自检等操作（这些和我们讲的启动操作系统没有直接的关系，读者不必关心）。由于我们把软盘设置为启动设备，计算机硬件体系结构的设计与BIOS联手操作，会让CPU接收到一个int 0x19中断。CPU接收到这个中断后，会立即在中断向量表中找到int 0x19中断向量。我们在图1-3的左下方可以看到int 0x19中断向量在内存中所在的准确位置，这个位置几乎紧挨着内存的0x00000位置。

接下来，中断向量把CPU指向0x0E6F2，这个位置就是int 0x19相对应的中断服务程序的入口地址，即图1-3所示的“启动加载服务程序”的入口地址。这个中断服务程序的作用就是把软盘第一扇区中的程序（512 B）加载到内存中的指定位置。这个中断服务程序的功能是BIOS事先设计好的，代码是固定的，与Linux操作系统无关。无论Linux 0.11的内核是如何设计的，这段BIOS程序所要做的就是“找到软盘”并“加载第一扇区”，其余的它什么都不知道，也不必知道。

小贴士

中断向量表（Interrupt Vector Table）：实模式中断机制的重要组成部分，记录所有中断号对应的中断服务程序的内存地址。

中断服务（Interrupt Service）程序：通过中断向量表的索引对中断进行响应服务，是一些具有特定功能的程序。



按照这个简单、“生硬”的规则，int 0x19中断向量所指向的中断服务程序，即启动加载服务程序，将软驱0号磁头对应盘面的0磁道1扇区的内容复制至内存0x07C00处。我们可以在图1-4的左边看到第一扇区加载的具体位置。



这个扇区里的内容就是 Linux 0.11 的引导程序，也就是我们将要讲解的bootsect，其作用就是陆续把软盘中的操作系统程序载入内存。这样制作的第一扇区就称为启动扇区（boot sector）。第一扇区程序的载入，标志着Linux 0.11中的代码即将发挥作用了。

这是非常关键的动作，从此计算机开始和软盘上的操作系统程序产生关联。第一扇区中的程序由bootsect.s中的汇编程序汇编而成（以后简称bootsect）。这是计算机自开机以来，内存中第一次有了Linux操作系统自己的代码，虽然只是启动代码。

至此，已经把第一批代码bootsect从软盘载入计算机的内存了。下面的工作就是执行bootsect把软盘的第二批、第三批代码载入内存。

点评

注意：BIOS程序固化在主机板上的ROM中，是根据具体的主机板而不是根据具体的操作系统设计的。

理论上，计算机可以安装任何适合其安装的操作系统，既可以安装Windows，也可以安装Linux。不难想象每个操作系统的设计者都可以设计出一套自己的操作系统启动方案，而操作系统和BIOS通常是由不同的专业团队设计和开发的，为了能协同工作，必须建立操作系统和BIOS之间的协调机制。

与已有的操作系统建立一一对应的协调机制虽然麻烦，但尚有可能，难点在于与未来的操作系统应该如何建立协调机制。现行的方法是“两头约定”和“定位识别”。

对操作系统（这里指Linux 0.11）而言，“约定”操作系统的设计者必须把最开始执行的程序“定位”在启动扇区(软盘中的0盘面0磁道1扇区)，其余的程序可以依照操作系统的设计顺序加载在后续的扇区中。

对BIOS而言，“约定”接到启动操作系统的命令，“定位识别”只从启动扇区把代码加载到0x07C00 (BOOTSEG)这个位置(参见Seabios 0.6.0/Boot.c文件中的boot_disk函数)。至于这个扇区中是否是启动程序、是什么操作系统，则不闻不问、一视同仁。如果不是启动代码，只会提示错误，其余是用户的责任，与BIOS无关。

这样构建协调机制的好处是站在整个体系的高度，统一设计、统一安排，简单、有效。只要BIOS和操作系统的生产厂商开发的所有系统版本全部遵循此机制的约定，就可以各自灵活地设计出具有自己特色的系统版本。


## Linux 启动

内核会在获得控制权之后进行各种设备的初始化。虽然固件程序已经初始化了一些设备，但内核会根据自己的需要再次进行初始化。

        Linux也会进行各种自身功能的初始化，如内存管理，进程管理等，这个阶段Linux内核无法加载模块，这些设备以及文件系统的驱动程序必须同内核编译进同意文件，以便内核使用，不能使用模块方式。

 3，启动控制程序
 

 
       linux内核启动完成后，将运行启动控制程序，Linux2.6有3种方式进入启动控制程序，
Initramfs:这是Linux2.6最新引入的启动控制方式。Initramfs是一个使用CPIO格式打包的文件，还原该文件将得到一个小型的Linux系统，linux内核将该系统作为启动系统，并将控制权交给其中的/init程序。
Initrd：Initrd文件是一个小型的文件系统，内部包含了启动所需的命令以及内核模块，内核将把该文件系统镜像到/Dev/ram0设备中，/Dev/ram0是内存磁盘设备，镜像还原后Linux内核会执行其中的/Linuxrc文件，该文件执行结束后返回linux内核，内核将执行权限交给根文件系统中的/sbin/init程序。
/sbin/init是标准的启动控制程序

        Linux内核启动时，启动器传递给内核的启动参数中可指定init启动控制程序。即，“init=<程序的绝对路径>"，如设定inti=/bin/bash，内核启动完成后不执行默认的/sbin/init，将直接执行bash命令进入交互界面。
        Initramfs和initrd都提供了一个小型的系统，该系统可根据不同的硬件环境进行特定的工作，这使得linux系统可以适应更多的硬件平台。
        在LiveCD中就使用Initramfs或initrd老保证在大多数的同类计算机上正常使用，Initramfs和initrd还可以用来帮助使系统的启动过程更加灵活。启动控制程序也是各种Linux发行版特别照顾的地方，一些精简或专用系统为了提高运行速度，对这方面的优化挖掘是乐此不疲。
        首先介绍比较传统的/sbin/init，该命令由Sysvinit软件包提供。inti命令有一个专用的配置文件inittab，该文件存放在/etc目录下，inittab文件可对linux系统的启动过程进行配置。常规的Linux系统设置了0~6级的启动方式，其定义如下
0：关闭计算机
1：单用户模式
2：无网络多用户模式
3：有网络多用户模式
4：保留为自定义，如无定义可视为运行级别3
5：同运行级别4，一般用于GUI的登录
6：重启系统
其中0和6在各发行版中的含义是相同的，而2~5级的可能会有所差别。但都是作为启动操作系统使用。在各级别启动模式中，程序根据需要加载执行，有些是共同的功能，比如加载必须的内核模块。还有一些就根据具体的的模式进行运行。现在有一些发行版尝试使用更先进的启动控制程序，比如openrc。与传统启动程序相比，这类启动程序进行各类启动的优化和改进，比如用二进制的程序代替脚本执行，采用并行的方式来提高启动速度。
        不管怎么样的启动控制程序，其目的都是在位用户环境进行准备，包括建立设备文件，启动服务等。完成这些工作之后，启动控制程序会将启动控制权限交给登录控制程序
4，登录控制程序
        linux是多用户系统，用户的登录是安全机制的一部分，也是启动过程中的一部分。在安全要求不高的情况下，有时系统也会使用自动登录的方式。登录控制程序有许多实现，表现形式也多种多样，如文本形式下的login程序，图形模式下的xdm、kdm和gdm等，通常的Linux使用密码的方式进行验证，当然也可以使用身份盘、指纹等验证方式。
        当用户顺利通过验证后，登录控制程序会按照相关的设置，为用户启动需要的程序，一般是允许用户跟系统进行交互的程序。如bash。
5，交互环境
        登录控制程序可以根据配置针对不同的用户启动不同的交互环境，比如bash会先去/etc中执行profile文件，之后执行用户目录下的.bashrc文件为用户设置个性化环境。在图形环境中，这个过程更加复杂。


